### 分布式事务方案总结

[TOC]

##### 一、XA两阶段提交

XA 是指由 X/Open 组织提出的分布式事务处理的规范。XA规范主要定义了Transaction Manager（TM）和Resource Manager（RM）之间的接口

![](https://tva1.sinaimg.cn/large/006tNbRwly1gbkrnxj9wkj30u20ckwgm.jpg)

XA协议的流程可大致分为三个步骤：

- 步骤1：APP向TM创建全局事务，TM向APP返回全局事务号。
- 步骤2：APP使用全局事务号，访问RM的资源（当RM为数据库时，资源访问就是SQL操作）。当RM第一次收到访问时，使用该全局事务号向TM注册，TM返回事务分支事务号。
- 步骤3：APP向TM发出全局事务提交请求，TM与参与事务的RM通信，进行提交处理，全部完成后，向APP返回结果

TM与RM之间的提交处理采用两阶段提交协议

##### 二、TCC模式

TCC模式为全局事务执行提供了一个框架，开发人员只需要实现每个事务分支的回滚，不需要记录整个事务流程的操作日志。TCC模式结构如下图:

![](https://tva1.sinaimg.cn/large/006tNbRwly1gbkrpe5963j30t60ke757.jpg)

- 一个完整的业务活动由一个主业务服务与若干从业务服务组成。
- 主业务服务负责发起并完成整个业务活动。
- 从业务服务提供TCC型业务操作。
- 业务活动管理器控制业务活动的一致性，它登记业务活动中的操作，并在业务活动提交时确认所有的TCC型操作的confirm操作，在业务活动取消时调用所有TCC型操作的cancel操作。

TCC业务包括两个阶段完成：

- 第一阶段：主业务服务分别调用所有从业务的 try 操作，并在活动管理器中登记所有从业务服务。当所有从业务服务的 try 操作都调用成功或者某个从业务服务的 try 操作失败，进入第二阶段。
- 第二阶段：活动管理器根据第一阶段的执行结果来执行 confirm 或 cancel 操作。
  如果第一阶段所有 try 操作都成功，则活动管理器调用所有从业务活动的 confirm操作。否则调用所有从业务服务的 cancel 操作。

##### 三、可靠消息

![](https://tva1.sinaimg.cn/large/006tNbRwly1gbks4ckiezj30u00n6tap.jpg)

- 业务处理服务在业务事务提交前，向实时消息服务请求发送消息，实时消息服务只记录消息数据，而不真正发送。
- 业务处理服务在业务事务提交后，向实时消息服务确认发送。只有在得到确认发送指令后，实时消息服务才真正发送消息。
- 业务处理服务在业务事务回滚后，向实时消息服务取消发送。
- 消息状态确认系统定期找到未确认发送或回滚发送的消息，向业务处理服务询问消息状态，业务处理服务根据消息ID或消息内容确定该消息是否有效。



##### 四、数据库事物原理

* undo日志
* redo日志

