### 《现代操作系统》学习笔记

##### 一、进程与线程

1. 进程的实现：

   * 进程表：每个进程占用一个进程表项（进程控制块），包含了进程状态的重要信息，包括程序计数器、堆栈指针、内存分配状况、所打开文件的状态、账号和调度信息，以及其他进程状态转换时必须保存的信息

     ![image-20210408160054482](https://tva1.sinaimg.cn/large/008eGmZEly1gpce98j696j30uu0jv15i.jpg)

   * 中断

     ![image-20210408160411431](https://tva1.sinaimg.cn/large/008eGmZEly1gpcecm4fd9j30k20bbwl7.jpg)

2. 多道程序设计模型

   ![image-20210408161501995](https://tva1.sinaimg.cn/large/008eGmZEly1gpcenwknelj30mp0gfgs5.jpg)

3. 线程

   * 为什么使用线程？

     * 提供了一种新的元素：并行实体拥有共享同一个地址攻坚和所有可用数据的能力
     * 线程比进程更轻量级，更容易创建和撤销
     * 如果存在大量的计算和大量的I/O处理，拥有多个线程允许彼此重叠进行，会加快应用程序的执行速度
     * 在多CPU系统中，多线程是有益的，在这样的系统中，真正的并行有了实现的可能

   * POSIX线程

     ![image-20210408172053863](https://tva1.sinaimg.cn/large/008eGmZEly1gpcgkeov4yj31190cd12h.jpg)

   * 线程调度机制

     * 用户线程
     * 内核线程
     * 混合线程
     * 调度程序激活机制

4. 进程间通信

   * 互斥量（共享内存）

     * 快速用户去互斥量 futex

     * pthread中的互斥量

       ![image-20210409150718727](https://tva1.sinaimg.cn/large/008eGmZEgy1gpdibsiwz1j317v0dz4d4.jpg)

   * 消息传递

   * 屏障

##### 二、内存管理

1. 地址空间

2. 虚拟内存

   * 分页（页面、页框）

   * 页表

     * 缺页中断
       * 次要缺页错误
       * 严重缺页错误
       * 段错误
     * 多级页表
     * 倒排页表

   * 虚拟地址空间

   * MMU：将虚拟地址翻译成物理地址

   * 转换检测缓冲区（TLB,又叫相联存储器或块表）：一个小型的硬件设备，将虚拟地址直接映射到物理地址，而不必再访问页表

   * 页面置换算法

     ![image-20210412150739888](https://tva1.sinaimg.cn/large/008eGmZEgy1gpgz72l5kdj30sy0g649r.jpg)

3. 分页系统中的设计问题

   1. 局部分配策略和全局分配策略
   2. 负载控制
   3. 页面大小
      * 小页面：内存利用率更高，运行时占用内存更小
      * 大页面：页表小，进程切换时载入页表更快，节省TLB资源
      * 综合考虑，为不同部分使用部分的页面大小，比如内核用大页面，用户进程用小页面
   4. 分离的指令空间和数据空间
   5. 共享页面
      * fork子进程时，生成独立的页表，但是共享页面，并且是只读的，更新采用写时复制策略
   6. 共享库
   7. 内存映射文件

4. 实现相关问题

   1. 分页有关的工作
      * 进程创建时
        * 创建页表，在内存中为页表分配空间并对其初始化
        * 磁盘交换区中分配空间，以便一个进程换出时在磁盘上有放置此进程的空间
        * 用程序正文和数据对交换区进行初始化，这样当进程放生缺页中断时，可以调入需要的页面
        * 需要把有关页表和磁盘交换区的信息存储在进程表中
      * 进程执行时
        * 重置MMU,刷新TLB
        * 新进程的页表成为当前页表
      * 缺页中断时
        * 确定虚拟地址
        * 定位页面
        * 寻找页框
        * 回退程序计数器，使程序计数器指向引起缺页中断的指令，并重新执行该指令
      * 进程终止时
        * 释放进程的页表、页面和页面在硬盘上所占用的空间
        * 如果某些时共享页面，当最后一个使用他们的进程终止时才可以释放内存和磁盘上的页面
   2. 缺页中断处理
      1. 硬件陷入内核，在堆栈中保存程序计数器。大多数机器将当前指令的各种状态信息保存在特殊的CPU寄存器中
      2. 启动一个汇编代码例程保存通用寄存器和其他易失的信息，以免被操作系统破坏。这个例程将操作系统作为一个函数来调用
      3. 当操作系统发现一个缺页中断时，尝试发现需要哪个虚拟页面
      4. 一旦知道了发生缺页中断的虚拟地址，操作系统检查这个地址是否有效，并检查存取与保护是否一致。如果不一致，项进程发出一个信号或者杀死该进程。如果地址有效且没有保护错误发生，系统则检查是否有空闲页框。如果没有空闲页框，执行页面置换算法寻找一个页面来淘汰
      5. 如果选择的页框是脏页，安排该页写回磁盘，并发生一次上下文切换，挂起产生缺页中断的进程，让其他进程运行直至磁盘传输结束
      6. 页框”干净“后，操作系统查找所需页面在磁盘上的地址，通过磁盘操作将其装入
      7. 磁盘中断发生时，表明该页已经被装入，页表已经更新可以反映他的位置，页框也被标记为正常状态
      8. 恢复发生缺页中断指令以前的状态，程序计数器重新指向这条指令
      9. 调度引发缺页中断的进程，操作系统返回调用它的汇编语言例程
      10. 该例程恢复寄存器和其他状态信息，返回到用户空间继续执行，就好像缺页中断没有发生过一样

   ##### 三、文件系统

   1. 文件
   2. 目录
   3. 文件系统实现
   4. 文件系统管理和优化
   5. 文件系统实例



